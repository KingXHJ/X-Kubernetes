## Pod Expulsion Mechanism in Resource Scarcity
在 Kubernetes 集群中，节点最重要的资源包括 CPU、内存和磁盘，其中，内存和磁盘资源属于不可压缩的资源，如果这类资源不足，则无法继续申请新的资源。同时，节点中现存的进程，包括操作系统的进程、用户进程（含 Pod 进程），随时可能申请更多的内存或磁盘资源，所以在资源严重不足的情况下，操作系统会触发 OOM Killer 的终极审批

为了避免出现这种严重后果，Kubernetes 设计和实现了一套自动化的 Pod 驱逐机制，该机制会自动从资源紧张的节点上驱逐一定数量的 Pod，以保证在该节点上有充足的资源。具体做法是通过 kubelet 实现 Pod 的驱逐过程，而 kubelet 也不是随机驱逐的，它有自己的一套驱逐机制，每个节点上的 kubelet 都会通过 cAdvisor 提供的资源使用指标来监控自身节点的资源使用量，并根据这些指标的变化做出相应的驱逐决定和操作。kubelet 持续监控主机的资源使用情况，尽量防止计算资源被耗尽，一旦出现资源紧缺的迹象，就会主动终止一个或多个 Pod 的运行，以回收紧缺的资源。当一个 Pod 被终止时，其中的容器会被全部停止，Pod 的状态会被设置为 Failed


### 驱逐时机
首先，在磁盘资源不足时会触发 Pod 的驱逐行为。Kubernetes 包括两种文件系统：nodefs 和 imagefs。nodefs 是 kubelet 用于存储卷系统、服务程序日志等的文件系统；imagefs 是容器运行时使用的可选文件系统，用于存储容器镜像和容器可写层数据。cAdvisor 提供了这两种文件系统的相关统计指标，分别如下。
- available：表示该文件系统中可用的磁盘空间
- inodesFree：表示该文件系统中可用的 inode 数量（索引节点数量）



### 驱逐阈值
1. 驱逐软阈值
1. 驱逐硬阈值



### 节点状态


### 节点状态的振荡



### 回收Node级别的资源
1. 有Imagefs时
1. 没有Imagefs时


### 驱逐用户的Pod
kubelet 如果无法在节点上回收足够的资源，就会开始驱逐用户的 Pod
kubelet 会按照下面的标准对 Pod 的驱逐行为进行判断
- Pod 要求的服务质量
- Pod 对紧缺资源的消耗量（相对于资源请求 Request）

1. 有Imagefs时
1. 没有Imagefs时


### 资源最少回收量



### 节点资源紧缺情况下的系统行为
1. 调度器的行为
1. Node 的 OOM 行为
1. 对 DaemonSet 类型的 Pod 驱逐的考虑



### 可调度的资源和驱逐策略实践



### 现阶段的问题
1. kubelet无法及时观测到内存压力
1. kubelet可能会错误地驱逐更多的Pod